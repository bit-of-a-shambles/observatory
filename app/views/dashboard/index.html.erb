<div data-controller="dashboard" class="animate-fade-up">
  <%# Header %>
  <header class="py-8 border-b border-white/10">
    <div class="flex items-center gap-3 mb-1">
      <div class="w-2.5 h-2.5 rounded-full bg-[#ff4444] shadow-[0_0_12px_rgba(255,68,68,0.5)] animate-pulse-slow"></div>
      <span class="font-mono text-[11px] tracking-[3px] text-white/40 font-semibold uppercase"><%= t("app.live") %></span>
    </div>
    <h1 class="font-['Space_Grotesk'] text-3xl font-bold tracking-tight bg-linear-to-r from-[#e8e0d4] to-[#c8a84e] bg-clip-text text-transparent mb-1">
      <%= t("app.name") %>
    </h1>
    <p class="text-white/35 text-sm">
      <%= t("app.tagline") %>
    </p>
  </header>

  <%# Stats bar %>
  <div class="grid grid-cols-4 gap-px my-6 bg-white/5 rounded-lg overflow-hidden">
    <% @stats.each do |stat| %>
      <div class="p-4 text-center bg-black/20">
        <div class="font-['Space_Grotesk'] text-2xl font-bold <%= stat[:color] %>">
          <%= stat[:value] %>
        </div>
        <div class="font-mono text-[10px] tracking-[2px] text-white/35 mt-0.5">
          <%= stat[:label] %>
        </div>
      </div>
    <% end %>
  </div>

  <%# Tabs %>
  <div class="flex border-b border-white/10 mb-6">
    <button data-dashboard-target="tab" data-tab="insights" data-action="click->dashboard#switchTab"
            class="font-mono text-xs tracking-widest uppercase bg-none border-none px-5 py-3 cursor-pointer transition-all font-semibold text-[#c8a84e] border-b-2 border-[#c8a84e]">
      <%= t("dashboard.tabs.insights") %> <%= @insights_count %>
    </button>
    <button data-dashboard-target="tab" data-tab="cruzamentos" data-action="click->dashboard#switchTab"
            class="font-mono text-xs tracking-widest uppercase bg-none border-none px-5 py-3 cursor-pointer transition-all font-semibold text-white/30 border-b-2 border-transparent">
      <%= t("dashboard.tabs.crossings") %>
    </button>
    <button data-dashboard-target="tab" data-tab="fontes" data-action="click->dashboard#switchTab"
            class="font-mono text-xs tracking-widest uppercase bg-none border-none px-5 py-3 cursor-pointer transition-all font-semibold text-white/30 border-b-2 border-transparent">
      <%= t("dashboard.tabs.sources") %>
    </button>
    <%= link_to contracts_path, class: "font-mono text-xs tracking-widest uppercase px-5 py-3 font-semibold text-white/30 border-b-2 border-transparent hover:text-white/60 transition-all ml-auto" do %>
      <%= t("nav.contracts") %> →
    <% end %>
  </div>

  <%# Insights Pane %>
  <div data-dashboard-target="pane" data-pane="insights" class="space-y-2">
    <%# Exposure banner %>
    <div class="bg-linear-to-br from-[#c8a84e14] to-[#ff44440f] border border-[#c8a84e26] border-l-4 border-l-[#c8a84e] rounded-lg p-7 mb-6">
      <div class="font-mono text-[10px] tracking-[3px] text-[#c8a84e] mb-1">
        <%= t("dashboard.exposure.label") %>
      </div>
      <div class="flex justify-between items-baseline">
        <span class="font-['Space_Grotesk'] text-5xl font-bold text-[#e8e0d4] tracking-tighter">
          <%= number_to_currency(@flagged_total_exposure || 0, unit: "€", delimiter: ",", separator: ".", format: "%u%n", precision: 2) %>
        </span>
        <div class="text-right font-mono text-sm">
          <div class="text-white/50"><%= t("dashboard.exposure.contracts", count: @flagged_contract_count) %></div>
          <div class="text-white/35"><%= t("dashboard.exposure.companies", count: @flagged_companies_count) %></div>
          <div class="text-white/35"><%= t("dashboard.exposure.public_entities", count: @flagged_public_entities_count) %></div>
        </div>
      </div>
    </div>

    <div class="border border-white/[0.08] rounded-lg p-5 mb-6 bg-black/10">
      <div class="flex flex-wrap items-end justify-between gap-4 mb-4">
        <div>
          <h2 class="font-['Space_Grotesk'] text-lg font-semibold text-[#e8e0d4]">
            <%= t("dashboard.entity_exposure.heading") %>
          </h2>
          <p class="font-mono text-[11px] tracking-wider text-white/35 mt-1">
            <%= t("dashboard.entity_exposure.subheading") %>
          </p>
        </div>
        <%= form_with url: dashboard_index_path, method: :get, local: true, class: "flex flex-wrap items-end gap-2.5" do |f| %>
          <div>
            <label class="block font-mono text-[10px] tracking-[2px] text-white/40 mb-1"><%= t("dashboard.entity_exposure.flag") %></label>
            <%= f.select :entity_flag_type,
                [[t("dashboard.entity_exposure.all_flags"), ""]] + @flag_types.map { |flag_type| [flag_type, flag_type] },
                { selected: @entity_flag_type },
                class: "bg-black/30 border border-white/10 rounded px-2.5 py-2 font-mono text-xs text-white/75 focus:outline-hidden focus:border-[#c8a84e66]" %>
          </div>
          <div>
            <label class="block font-mono text-[10px] tracking-[2px] text-white/40 mb-1"><%= t("dashboard.entity_exposure.sort") %></label>
            <%= f.select :entity_sort,
                [
                  [t("dashboard.entity_exposure.sort_value"), "value"],
                  [t("dashboard.entity_exposure.sort_count"), "count"]
                ],
                { selected: @entity_sort },
                class: "bg-black/30 border border-white/10 rounded px-2.5 py-2 font-mono text-xs text-white/75 focus:outline-hidden focus:border-[#c8a84e66]" %>
          </div>
          <%= f.submit t("contracts.index.filter"), class: "bg-[#c8a84e22] text-[#c8a84e] border border-[#c8a84e44] px-3 py-2 rounded font-mono text-xs font-semibold tracking-[1px] hover:bg-[#c8a84e33] transition-colors cursor-pointer" %>
        <% end %>
      </div>

      <% if @entity_exposure_rows.empty? %>
        <div class="font-mono text-xs text-white/35 py-2">
          <%= t("dashboard.entity_exposure.empty") %>
        </div>
      <% else %>
        <div class="overflow-x-auto">
          <div class="min-w-[720px]">
            <div class="grid grid-cols-[220px_1fr_180px_160px] gap-3 font-mono text-[10px] tracking-[2px] text-white/35 border-b border-white/8 pb-2">
              <span><%= t("dashboard.entity_exposure.col_flag") %></span>
              <span><%= t("dashboard.entity_exposure.col_entity") %></span>
              <span class="text-right"><%= t("dashboard.entity_exposure.col_value") %></span>
              <span class="text-right"><%= t("dashboard.entity_exposure.col_count") %></span>
            </div>
            <div class="divide-y divide-white/5">
              <% @entity_exposure_rows.each do |row| %>
                <div class="grid grid-cols-[220px_1fr_180px_160px] gap-3 py-2.5 font-mono text-xs">
                  <span class="text-[#c8a84e]"><%= row.flag_type.to_s.tr("_", " ").squeeze(" ").strip %></span>
                  <span class="text-white/75"><%= row.entity_name %></span>
                  <span class="text-right text-white/65"><%= number_to_currency(row.exposure_value, unit: "€", delimiter: ",", separator: ".", format: "%u%n", precision: 2) %></span>
                  <span class="text-right text-[#e8e0d4]"><%= number_with_delimiter(row.exposure_count) %></span>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>

  </div>

  <%# Crossings Pane %>
  <div data-dashboard-target="pane" data-pane="cruzamentos" class="hidden">
    <h2 class="font-['Space_Grotesk'] text-xl font-semibold mb-2 text-[#e8e0d4]"><%= t("dashboard.crossings.heading") %></h2>
    <p class="text-white/40 text-sm mb-6"><%= t("dashboard.crossings.subheading") %></p>
    <div class="border border-white/8 rounded-lg overflow-hidden">
      <div class="grid grid-cols-[1fr_120px] bg-white/3 p-3 px-5 border-b border-white/8 font-mono text-[11px] tracking-widest text-white/40">
        <span><%= t("dashboard.crossings.col_crossing") %></span>
        <span class="text-right"><%= t("dashboard.crossings.col_count") %></span>
      </div>
      <% @crossings.each do |row| %>
        <div class="grid grid-cols-[1fr_120px] p-3.5 px-5 border-b border-white/4 last:border-0 font-mono text-sm">
          <span class="text-white/60"><%= row[:label] %></span>
          <span class="text-[#c8a84e] font-bold text-right"><%= row[:count] %></span>
        </div>
      <% end %>
    </div>
  </div>

  <%# Sources Pane %>
  <div data-dashboard-target="pane" data-pane="fontes" class="hidden">
    <h2 class="font-['Space_Grotesk'] text-xl font-semibold mb-2"><%= t("dashboard.sources.heading") %></h2>
    <p class="text-white/40 text-sm mb-6"><%= t("dashboard.sources.subheading") %></p>
    <div class="grid grid-cols-2 gap-2">
      <% @sources.each do |source| %>
        <% dot_color = source[:status] == "active" ? "bg-[#44ff88] shadow-[0_0_6px_rgba(68,255,136,0.4)]" :
                       source[:status] == "error"  ? "bg-[#ff4444] shadow-[0_0_6px_rgba(255,68,68,0.4)]"  :
                                                     "bg-white/20" %>
        <div class="p-4 px-5 border border-white/6 rounded-lg bg-white/2">
          <div class="flex justify-between items-center mb-1.5">
            <div>
              <span class="font-bold text-sm text-[#e8e0d4]"><%= source[:name] %></span>
              <span class="font-mono text-[10px] text-white/25 ml-2"><%= source[:country] %></span>
            </div>
            <div class="flex items-center gap-1.5">
              <div class="w-1.5 h-1.5 rounded-full <%= dot_color %>"></div>
              <span class="font-mono text-[10px] text-white/35 uppercase"><%= source[:status] %></span>
            </div>
          </div>
          <div class="flex justify-between font-mono">
            <span class="text-[11px] text-white/35"><%= source[:type] %></span>
            <span class="text-xs text-[#c8a84e]"><%= t("dashboard.sources.records", count: source[:records]) %></span>
          </div>
          <% if source[:synced_at] %>
            <div class="font-mono text-[10px] text-white/20 mt-1"><%= t("dashboard.sources.synced", date: source[:synced_at]) %></div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <%# Footer %>
  <footer class="py-10 border-t border-white/4 mt-12 text-center space-y-1">
    <div class="font-mono text-[10px] tracking-[2px] text-white/20">
      <%= t("app.name") %>
    </div>
    <div class="font-mono text-[10px] text-white/15">
      <%= link_to t("app.footer_repo"), "https://github.com/bit-of-a-shambles/open-tender-watch",
          target: "_blank", rel: "noopener noreferrer",
          class: "hover:text-white/35 transition-colors" %>
    </div>
  </footer>
</div>
