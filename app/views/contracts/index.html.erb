<div class="animate-fade-up">
  <%# Header %>
  <header class="py-8 border-b border-white/10">
    <div class="flex items-center gap-3 mb-1">
      <%= link_to root_path, class: "font-mono text-[11px] tracking-[2px] text-white/30 hover:text-white/60 transition-colors" do %>
        ← <%= t("nav.dashboard") %>
      <% end %>
    </div>
    <h1 class="font-['Space_Grotesk'] text-3xl font-bold tracking-tight bg-gradient-to-r from-[#e8e0d4] to-[#c8a84e] bg-clip-text text-transparent mb-1 mt-2">
      <%= t("contracts.index.title") %>
    </h1>
    <p class="text-white/35 text-sm">
      <%= t("contracts.index.subtitle", count: @total, total: number_with_delimiter(@total), all: number_with_delimiter(Contract.count)) %>
    </p>
  </header>

  <%# Filters %>
  <%= form_with url: contracts_path, method: :get, local: true, class: "flex flex-wrap gap-2 my-6" do |f| %>
    <div class="flex-1 min-w-[200px]">
      <%= f.text_field :q, value: params[:q], placeholder: t("contracts.index.search_placeholder"),
          class: "w-full bg-white/[0.04] border border-white/[0.1] rounded px-3 py-2 font-mono text-xs text-[#e8e0d4] placeholder-white/20 focus:outline-none focus:border-[#c8a84e55] focus:bg-white/[0.06] transition-all" %>
    </div>
    <div>
      <%= f.select :procedure_type,
          [[t("contracts.index.all_procedures"), ""]] + @procedure_types.map { |type| [type, type] },
          { selected: params[:procedure_type] },
          class: "bg-white/[0.04] border border-white/[0.1] rounded px-3 py-2 font-mono text-xs text-[#e8e0d4] focus:outline-none focus:border-[#c8a84e55] transition-all" %>
    </div>
    <div>
      <%= f.select :country,
          [[t("contracts.index.all_countries"), ""]] + @countries.map { |c| [c, c] },
          { selected: params[:country] },
          class: "bg-white/[0.04] border border-white/[0.1] rounded px-3 py-2 font-mono text-xs text-[#e8e0d4] focus:outline-none focus:border-[#c8a84e55] transition-all" %>
    </div>
    <div>
      <%= f.select :flagged,
          [
            [t("contracts.index.all_flag_states"), ""],
            [t("contracts.index.flagged_only"), "only"],
            [t("contracts.index.unflagged_only"), "none"]
          ],
          { selected: params[:flagged] },
          class: "bg-white/[0.04] border border-white/[0.1] rounded px-3 py-2 font-mono text-xs text-[#e8e0d4] focus:outline-none focus:border-[#c8a84e55] transition-all" %>
    </div>
    <div>
      <%= f.select :flag_type,
          [[t("contracts.index.all_flags"), ""]] + @flag_types.map { |flag_type| [flag_type, flag_type] },
          { selected: params[:flag_type] },
          class: "bg-white/[0.04] border border-white/[0.1] rounded px-3 py-2 font-mono text-xs text-[#e8e0d4] focus:outline-none focus:border-[#c8a84e55] transition-all" %>
    </div>
    <%= f.submit t("contracts.index.filter"),
        class: "bg-[#c8a84e1a] border border-[#c8a84e44] text-[#c8a84e] font-mono text-xs tracking-widest px-4 py-2 rounded hover:bg-[#c8a84e33] transition-all cursor-pointer" %>
    <% if params[:q].present? || params[:procedure_type].present? || params[:country].present? || params[:flagged].present? || params[:flag_type].present? %>
      <%= link_to t("contracts.index.clear"), contracts_path,
          class: "border border-white/10 text-white/30 font-mono text-xs tracking-widest px-4 py-2 rounded hover:text-white/50 transition-all" %>
    <% end %>
  <% end %>

  <%# Table %>
  <div class="border border-white/[0.08] rounded-lg overflow-hidden">
    <%# Header row %>
    <div class="grid grid-cols-[1fr_180px_140px_120px_90px] bg-white/[0.03] px-5 py-3 border-b border-white/[0.08] font-mono text-[10px] tracking-[2px] text-white/35 uppercase">
      <span><%= t("contracts.index.col_contract") %></span>
      <span><%= t("contracts.index.col_entity") %></span>
      <span><%= t("contracts.index.col_procedure") %></span>
      <span class="text-right"><%= t("contracts.index.col_price") %></span>
      <span class="text-right"><%= t("contracts.index.col_date") %></span>
    </div>

    <% if @contracts.empty? %>
      <div class="px-5 py-12 text-center font-mono text-sm text-white/25">
        <%= t("contracts.index.empty") %>
      </div>
    <% else %>
      <% @contracts.each do |contract| %>
        <%= link_to contract_path(contract), class: "grid grid-cols-[1fr_180px_140px_120px_90px] px-5 py-3.5 border-b border-white/[0.04] last:border-0 hover:bg-white/[0.03] transition-colors group items-start" do %>
          <div class="pr-4">
            <div class="text-sm text-[#e8e0d4] group-hover:text-white transition-colors line-clamp-2 leading-snug">
              <%= contract.object %>
            </div>
            <div class="font-mono text-[10px] text-white/25 mt-1">
              <%= contract.country_code %> · <%= contract.external_id %>
            </div>
            <% if contract.flags.any? %>
              <div class="mt-1.5 flex flex-wrap gap-1">
                <% contract.flags.first(2).each do |flag| %>
                  <span class="font-mono text-[9px] tracking-wide text-[#ff6666] bg-[#ff444412] border border-[#ff444433] px-1.5 py-0.5 rounded">
                    <%= flag.flag_type %>
                  </span>
                <% end %>
                <% if contract.flags.size > 2 %>
                  <span class="font-mono text-[9px] text-white/35">+<%= contract.flags.size - 2 %></span>
                <% end %>
              </div>
            <% end %>
          </div>
          <div class="text-xs text-white/50 truncate pr-4 pt-0.5">
            <%= contract.contracting_entity&.name %>
          </div>
          <div class="pr-4 pt-0.5">
            <% if contract.procedure_type.present? %>
              <span class="font-mono text-[10px] text-white/40 bg-white/[0.04] px-2 py-0.5 rounded border border-white/[0.06] leading-tight inline-block">
                <%= contract.procedure_type.truncate(22) %>
              </span>
            <% end %>
          </div>
          <div class="text-right font-mono text-xs text-[#c8a84e] font-medium pt-0.5">
            <% if contract.base_price.present? %>
              €<%= number_with_delimiter(contract.base_price.to_i) %>
            <% else %>
              <span class="text-white/20">—</span>
            <% end %>
          </div>
          <div class="text-right font-mono text-[11px] text-white/35 pt-0.5">
            <%= contract.celebration_date&.strftime("%Y-%m-%d") || "—" %>
          </div>
        <% end %>
      <% end %>
    <% end %>
  </div>

  <%# Pagination %>
  <% if @total_pages > 1 %>
    <div class="flex items-center justify-between mt-6 font-mono text-xs text-white/35">
      <span>
        <%= t("contracts.index.pagination.info", page: @page, total_pages: @total_pages, total: number_with_delimiter(@total)) %>
      </span>
      <div class="flex gap-2">
        <% if @page > 1 %>
          <%= link_to t("contracts.index.pagination.prev"), contracts_path(request.query_parameters.merge(page: @page - 1)),
              class: "border border-white/10 px-3 py-1.5 rounded hover:border-[#c8a84e44] hover:text-[#c8a84e] transition-all" %>
        <% end %>
        <% if @page < @total_pages %>
          <%= link_to t("contracts.index.pagination.next"), contracts_path(request.query_parameters.merge(page: @page + 1)),
              class: "border border-white/10 px-3 py-1.5 rounded hover:border-[#c8a84e44] hover:text-[#c8a84e] transition-all" %>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
